#!/bin/bash

COMPILER="${DATAFLOW_CC:-@CLANG_BINARY@}"
THIS_DIR=$(dirname $(readlink -f $0))

if [[ $# -eq 0 ]]; then
  echo "Use $(basename $0) as a drop-in replacement for clang" >&2
  exit 1
fi

LIB_DIR=$(realpath "${THIS_DIR}/../lib")
if [[ ! -d "${LIB_DIR}" ]]; then
  echo "ERROR: Unable to find pass lib dir"
  exit 1
fi

exec $COMPILER                                                  \
    -g                                                          \
    -Xclang -load -Xclang "${LIB_DIR}/libMem2Reg.so"            \
    -Xclang -load -Xclang "${LIB_DIR}/libLowerDbgDeclare.so"    \
    -Xclang -load -Xclang "${LIB_DIR}/libLowerAtomics.so"       \
    -Xclang -load -Xclang "${LIB_DIR}/libLowerMemIntrinsics.so" \
    -Xclang -load -Xclang "${LIB_DIR}/libLowerConstantExprs.so" \
    -Xclang -load -Xclang "${LIB_DIR}/libVariableRecovery.so"   \
    -Xclang -load -Xclang "${LIB_DIR}/libMemFuncIdentify.so"    \
    -Xclang -load -Xclang "${LIB_DIR}/libDefSiteIdentify.so"    \
    -Xclang -load -Xclang "${LIB_DIR}/libUseSiteIdentify.so"    \
    -Xclang -load -Xclang "${LIB_DIR}/libHeapify.so"            \
    "$@"                                                        \
    -Qunused-arguments
